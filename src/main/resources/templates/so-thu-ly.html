<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Sổ Thụ Lý</title>

    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"/>

    <style>
        .content-note {
            font-size: 12px;
            font-weight: normal;
        }

        /* scroll ngang */
        .table-responsive-horizontal {
            overflow-x: auto;
            /*white-space: nowrap;*/
            position: relative;
        }

        /* Cố định cột Hành động */
        th.sticky-action,
        td.sticky-action {
            position: sticky;
            right: 0;
            background: #ffffff;
            z-index: 10;

            /* Thêm border rõ ràng */
            border-left: 2px solid #dee2e6;   /* Giống border table Bootstrap */
            border-right: 2px solid #dee2e6;
            box-shadow: -4px 0 6px -2px rgba(0,0,0,0.2);
        }

        /* Header ưu tiên hơn body */
        th.sticky-action {
            z-index: 11;
        }

        .copy-tooltip {
            position: absolute;
            top: -22px;
            left: 0;
            background: #000;
            color: #fff;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            white-space: nowrap;
            opacity: 1;
            transition: opacity 0.3s ease;
            z-index: 999;
        }

        .copy-tooltip.fade-out {
            opacity: 0;
        }

        .btn-copy {
            border: none !important;       /* bỏ border */
            outline: none !important;      /* bỏ outline khi focus */
            background: transparent;       /* bỏ nền */
            padding: 0 4px;                /* thu nhỏ nút cho gọn */
            cursor: pointer;               /* con trỏ dạng click */
        }

        .btn-copy i {
            font-size: 14px;
            color: #666;                   /* màu icon copy */
            transition: 0.2s;
        }

        /* hiệu ứng nhấn copy */
        .btn-copy.copied i {
            color: #000;
            transform: scale(1.3);
        }

    </style>
</head>
<body class="p-4">
<!-- ⬇⬇⬇ LOADER ĐƯỢC INJECT Ở ĐÂY -->
<div th:replace="fragments/loader :: loader"></div>
<!-- ⬆⬆⬆ -->

<h2>Danh sách sổ thụ lý</h2>

<!-- ======================= TÌM KIẾM ======================= -->
<div class="d-flex gap-3 mb-3 align-items-end">

    <button class="btn btn-info gap-2" onclick="searchData()">
        <i class="fa fa-search"></i> Tìm
    </button>

    <div class="d-flex align-items-center gap-2">
        <label class="form-label mb-0">Từ ngày</label>
        <input id="searchFrom" class="form-control" style="width:150px;" placeholder="dd-MM-yyyy">
    </div>

    <div class="d-flex align-items-center gap-2">
        <label class="form-label mb-0">Đến ngày</label>
        <input id="searchTo" class="form-control" style="width:150px;" placeholder="dd-MM-yyyy">
    </div>

    <div class="d-flex gap-2 ms-auto">
        <button class="btn btn-primary" onclick="openCreateModal()">+ Thêm mới</button>
        <button class="btn btn-success" onclick="exportExcel()">Export Excel</button>
    </div>

</div>

<!-- ======================= TABLE ======================= -->
<div class="table-responsive-horizontal">
    <table class="table table-bordered table-striped table-sm">
        <thead class="table-cell">
        <tr>
            <th rowspan="2" class="text-center align-middle">ID</th>
            <th rowspan="2" class="text-center align-middle">Ngày TL</th>
            <th rowspan="2" class="text-center align-middle">Bản án, Quyết định<br><span class="content-note">(Số; Ngày, tháng, năm; Cơ quan ban hành)</span></th>
            <th rowspan="2" class="text-center align-middle">Người phải thi hành<br><span class="content-note">(tên địa chỉ)</span></th>
            <th rowspan="2" class="text-center align-middle">Người được thi hành<br><span class="content-note">(tên địa chỉ)</span></th>
            <th rowspan="2" class="text-center align-middle">QĐ Ủy thác đi<br><span class="content-note">(Số; Ngày, tháng, năm; Số tiền; Nơi BH)</span></th>
            <th rowspan="2" class="text-center align-middle">QĐ Ủy thác đến<br><span class="content-note">(Số; Ngày, tháng, năm; Số tiền; Nơi BH)</span></th>

            <th rowspan="2" class="text-center align-middle">QĐ thi hành án dân sự<br><span class="content-note">(Số; Ngày, tháng, năm; Số tiền)</span></th>
            <th rowspan="2" class="text-center align-middle">Nội dung thi hành<br><span class="content-note">(Các khoản phải thi hành, số tiền)</span></th>
            <th rowspan="2" class="text-center align-middle">QĐ về việc chưa có điều kiện thi hành án dân sự<br><span class="content-note">(Số; Ngày, tháng, năm; Số tiền)</span></th>
            <th rowspan="2" class="text-center align-middle">QĐ rút Quyết định THA<br><span class="content-note">(Số; Ngày, tháng, năm; Số tiền)</span></th>


            <th colspan="2" class="text-center align-middle">QĐ hoãn thi hành án Dân sự</th>

            <th colspan="2" class="text-center align-middle">QĐ tạm đình chỉ thi hành án dân sự</th>

            <th rowspan="2" class="text-center align-middle">QĐ đình chỉ thi hành án dân sự<br><span class="content-note">(Số; Ngày, tháng, năm; Số tiền)</span></th>
            <th rowspan="2" class="text-center align-middle">Đã thi hành xong<br><span class="content-note">(Số; Ngày, tháng, năm; Số tiền)</span></th>

            <th rowspan="2" class="text-center align-middle">Kiểm sát viên</th>
            <th rowspan="2" class="text-center align-middle">Về thời hạn gửi Quyết định</th>
            <th rowspan="2" class="text-center align-middle">Về căn cứ ban hành Quyết định</th>
            <th rowspan="2" class="text-center align-middle">Về thẩm quyền ban hành Quyết định</th>
            <th rowspan="2" class="text-center align-middle">Về hình thức của Quyết định</th>
            <th rowspan="2" class="text-center align-middle">Về nội dung của Quyết định</th>
            <th rowspan="2" class="text-center align-middle">Những nội dung khác</th>
            <th rowspan="2" class="text-center align-middle">Quan điểm của KSV</th>
            <th rowspan="2" class="text-center align-middle">Khu vực</th>
            <th rowspan="2" class="text-center align-middle">Tên Viện KSND Cấp</th>
            <th rowspan="2" class="text-center align-middle">Mã Phiếu</th>
            <th rowspan="2" class="text-center align-middle sticky-action">Hành động</th>
        </tr>
        <tr>
            <th class="align-middle"><span class="content-note">Số; Ngày, tháng, năm; Lý do Số tiền</span></th>
            <th class="align-middle">QĐ tiếp tục THA<br><span class="content-note">(Số; Ngày, tháng, năm)</span></th>

            <th class="align-middle"><span class="content-note">Số; Ngày, tháng, năm; Lý do Số tiền</span></th>
            <th class="align-middle">QĐ tiếp tục THA<br><span class="content-note">(Số; Ngày, tháng, năm)</span></th>
        </tr>
        </thead>

        <tbody id="tableBody">

        <!-- Load lần đầu nếu có dữ liệu -->
        <tr th:each="item, stat : ${list}">
            <td>
                <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                <span th:text="${stat.count}"></span>
            </td>
            <td>
                <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                <span th:text="${item.formatDateNgayTl}"></span>
            </td>

            <td>
                <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                <span th:text="${item.banAnQuyetDinh}"></span>
            </td>

            <td>
                <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                <span th:text="${item.personWhoMustExecute}"></span>
            </td>

            <td>
                <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                <span th:text="${item.personToBeExecuted}"></span>
            </td>

            <td>
                <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                <span th:text="${item.qdUyThacDi}"></span>
            </td>

            <td>
                <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                <span th:text="${item.qdUyThacDen}"></span>
            </td>

            <td>
                <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                <span th:text="${item.qdTha}"></span>
            </td>

            <td>
                <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                <span th:text="${item.ndThiHanh}"></span>
            </td>

            <td>
                <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                <span th:text="${item.qdChuaCoDieuKien}"></span>
            </td>

            <td>
                <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                <span th:text="${item.qdRutTha}"></span>
            </td>

            <td>
                <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                <span th:text="${item.qdHoanTha}"></span>
            </td>

            <td>
                <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                <span th:text="${item.qdTiepTucSauHoan}"></span>
            </td>

            <td>
                <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                <span th:text="${item.qdTamDinhChi}"></span>
            </td>

            <td>
                <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                <span th:text="${item.qdTiepTucSauTamDinhChi}"></span>
            </td>

            <td>
                <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                <span th:text="${item.qdDinhChi}"></span>
            </td>

            <td>
                <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                <span th:text="${item.daThiHanhXong}"></span>
            </td>

            <td>
                <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                <span th:text="${item.ghiChu}"></span>
            </td>

            <td>
                <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                <span th:text="${item.veThoiHanGuiQD}"></span>
            </td>

            <td>
                <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                <span th:text="${item.veCanCuBanHanhQD}"></span>
            </td>

            <td>
                <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                <span th:text="${item.veThamQuyenBanHanhQD}"></span>
            </td>

            <td>
                <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                <span th:text="${item.veHinhThucQD}"></span>
            </td>

            <td>
                <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                <span th:text="${item.veNoiDungQD}"></span>
            </td>

            <td>
                <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                <span th:text="${item.noiDungKhac}"></span>
            </td>

            <td>
                <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                <span th:text="${item.quanDiemKSV}"></span>
            </td>

            <td>
                <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                <span th:text="${item.khuVuc}"></span>
            </td>

            <td>
                <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                <span th:text="${item.vienKsndCap}"></span>
            </td>

            <td>
                <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                <span th:text="${item.maPhieu}"></span>
            </td>

            <td th:class="sticky-action" class="sticky-action">
                <button class="btn btn-warning btn-sm"
                        th:onclick="'openEditModal(' + ${item.id} + ')'">Sửa</button>
                <button class="btn btn-danger btn-sm"
                        th:onclick="'deleteItem(' + ${item.id} + ')'">Xóa</button>
                <button class="btn btn-info btn-sm"
                        th:onclick="'showloadFileDoc(' + ${item.id} + ')'"><i class="fa fa-download"></i> .Doc</button>
            </td>
        </tr>

        </tbody>
    </table>
</div>

<!-- PAGINATION -->
<div id="pagination" class="mt-2 d-flex gap-1"></div>

<!-- ======================= MODAL ======================= -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Thêm / Sửa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <input type="hidden" id="id">

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>STT sổ thử lý</label>
                        <input type="text" id="orderNumber" class="form-control">
                    </div>

                    <div class="col-md-6 mb-3">
                        <label>Ngày TL</label>
                        <input id="sttNgayTl" class="form-control" placeholder="dd-MM-yyyy">
                    </div>

                    <div class="col-md-6 mb-3">
                        <label>Bản án - Quyết định</label>
                        <input type="text" id="banAnQuyetDinh" class="form-control">
                    </div>

                    <div class="col-md-6 mb-3">
                        <label>Người phải thi hành</label>
                        <input type="text" id="personWhoMustExecute" class="form-control">
                    </div>

                    <div class="col-md-6 mb-3">
                        <label>Người được thi hành</label>
                        <input type="text" id="personToBeExecuted" class="form-control">
                    </div>

                    <div class="col-md-6 mb-3">
                        <label>QĐ Ủy thác đi</label>
                        <input type="text" id="qdUyThacDi" class="form-control">
                    </div>

                    <div class="col-md-6 mb-3">
                        <label>QĐ Ủy thác đến</label>
                        <input type="text" id="qdUyThacDen" class="form-control">
                    </div>

                    <div class="col-md-6 mb-3">
                        <label>QĐ THA dân sự</label>
                        <input type="text" id="qdTha" class="form-control">
                    </div>

                    <div class="col-md-6 mb-3">
                        <label>Nội dung thi hành</label>
                        <input type="text" id="ndThiHanh" class="form-control">
                    </div>

                    <div class="col-md-6 mb-3">
                        <label>QĐ chưa có điều kiện</label>
                        <input type="text" id="qdChuaCoDieuKien" class="form-control">
                    </div>

                    <div class="col-md-6 mb-3">
                        <label>QĐ rút THA</label>
                        <input type="text" id="qdRutTha" class="form-control">
                    </div>

                    <div class="col-md-6 mb-3">
                        <label>QĐ hoãn THA</label>
                        <input type="text" id="qdHoanTha" class="form-control">
                    </div>

                    <div class="col-md-6 mb-3">
                        <label>QĐ tiếp tục sau hoãn</label>
                        <input type="text" id="qdTiepTucSauHoan" class="form-control">
                    </div>

                    <div class="col-md-6 mb-3">
                        <label>QĐ tạm đình chỉ</label>
                        <input type="text" id="qdTamDinhChi" class="form-control">
                    </div>

                    <div class="col-md-6 mb-3">
                        <label>QĐ tiếp tục sau tạm đình chỉ</label>
                        <input type="text" id="qdTiepTucSauTamDinhChi" class="form-control">
                    </div>

                    <div class="col-md-6 mb-3">
                        <label>QĐ đình chỉ</label>
                        <input type="text" id="qdDinhChi" class="form-control">
                    </div>

                    <div class="col-md-6 mb-3">
                        <label>Đã thi hành xong</label>
                        <input type="text" id="daThiHanhXong" class="form-control">
                    </div>

                    <div class="col-md-6 mb-3">
                        <label>Kiểm sát viên</label>
                        <input type="text" id="ghiChu" class="form-control">
                    </div>

                    <div class="col-md-6 mb-3">
                        <label>Về thời hạn gửi QĐ</label>
                        <input type="text" id="veThoiHanGuiQD" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>Về căn cứ ban hành QĐ</label>
                        <input type="text" id="veCanCuBanHanhQD" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>Về thẩm quyền ban hành QĐ</label>
                        <input type="text" id="veThamQuyenBanHanhQD" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>Về hình thức của QĐ</label>
                        <input type="text" id="veHinhThucQD" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>Về nội dung của QĐ</label>
                        <input type="text" id="veNoiDungQD" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>Những nội dung khác</label>
                        <input type="text" id="noiDungKhac" class="form-control">
                    </div>

                    <div class="col-md-6 mb-3">
                        <label>Mã Phiếu</label>
                        <input type="text" id="maPhieu" class="form-control">
                    </div>

                    <div class="col-md-6 mb-3">
                        <label>Tên Viện KSND Cấp</label>
                        <input type="text" id="vienKsndCap" class="form-control">
                    </div>

                    <div class="col-md-6 mb-3">
                        <label>Khu vực</label>
                        <input type="text" id="khuVuc" class="form-control">
                    </div>

                    <div class="col-md-6 mb-3">
                        <label>Quan điểm của KSV</label>
                        <input type="text" id="quanDiemKSV" class="form-control">
                    </div>

                </div>
            </div>

            <div class="modal-footer">
                <button type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal">Đóng</button>

                <button class="btn btn-primary" onclick="saveItem()">Lưu</button>
            </div>

        </div>
    </div>
</div>


<!-- ================== JAVASCRIPT ================== -->
<script>

    /* ====== Flatpickr cho tất cả input ngày ====== */
    flatpickr("#searchFrom", { dateFormat: "d-m-Y" });
    flatpickr("#searchTo", { dateFormat: "d-m-Y" });
    flatpickr("#sttNgayTl", { dateFormat: "d-m-Y" });


    /* ====== MỞ MODAL THÊM ====== */
    function openCreateModal() {
        $("#modalTitle").text("Thêm mới");
        $("#id").val("");
        $("#editModal input").val("");
        $("#editModal").modal("show");
    }


    /* ====== LẤY DỮ LIỆU EDIT ====== */
    function openEditModal(id) {
        $.get("/api/so-thu-ly/" + id, function (d) {
            $("#id").val(d.id);
            $("#sttNgayTl").val(d.sttNgayTl);
            $("#banAnQuyetDinh").val(d.banAnQuyetDinh);
            $("#orderNumber").val(d.orderNumber);
            $("#personWhoMustExecute").val(d.personWhoMustExecute);
            $("#personToBeExecuted").val(d.personToBeExecuted);
            $("#qdUyThacDi").val(d.qdUyThacDi);
            $("#qdUyThacDen").val(d.qdUyThacDen);
            $("#qdTha").val(d.qdTha);
            $("#ndThiHanh").val(d.ndThiHanh);
            $("#qdChuaCoDieuKien").val(d.qdChuaCoDieuKien);
            $("#qdRutTha").val(d.qdRutTha);
            $("#qdHoanTha").val(d.qdHoanTha);
            $("#qdTiepTucSauHoan").val(d.qdTiepTucSauHoan);
            $("#qdTamDinhChi").val(d.qdTamDinhChi);
            $("#qdTiepTucSauTamDinhChi").val(d.qdTiepTucSauTamDinhChi);
            $("#qdDinhChi").val(d.qdDinhChi);
            $("#daThiHanhXong").val(d.daThiHanhXong);
            $("#ghiChu").val(d.ghiChu);
            $("#veThoiHanGuiQD").val(d.veThoiHanGuiQD);
            $("#veCanCuBanHanhQD").val(d.veCanCuBanHanhQD);
            $("#veThamQuyenBanHanhQD").val(d.veThamQuyenBanHanhQD);
            $("#veHinhThucQD").val(d.veHinhThucQD);
            $("#veNoiDungQD").val(d.veNoiDungQD);
            $("#noiDungKhac").val(d.noiDungKhac);
            $("#quanDiemKSV").val(d.quanDiemKSV);
            $("#maPhieu").val(d.maPhieu);
            $("#vienKsndCap").val(d.vienKsndCap);
            $("#khuVuc").val(d.khuVuc);
            $("#editModal").modal("show");
        });
    }


    /* ====== LƯU ====== */
    function saveItem() {
        showLoader();
        let data = {
            id: $("#id").val(),
            sttNgayTl: $("#sttNgayTl").val(),
            banAnQuyetDinh: $("#banAnQuyetDinh").val(),
            orderNumber: $("#orderNumber").val(),
            personWhoMustExecute: $("#personWhoMustExecute").val(),
            personToBeExecuted: $("#personToBeExecuted").val(),
            qdUyThacDi: $("#qdUyThacDi").val(),
            qdUyThacDen: $("#qdUyThacDen").val(),
            qdTha: $("#qdTha").val(),
            ndThiHanh: $("#ndThiHanh").val(),
            qdChuaCoDieuKien: $("#qdChuaCoDieuKien").val(),
            qdRutTha: $("#qdRutTha").val(),
            qdHoanTha: $("#qdHoanTha").val(),
            qdTiepTucSauHoan: $("#qdTiepTucSauHoan").val(),
            qdTamDinhChi: $("#qdTamDinhChi").val(),
            qdTiepTucSauTamDinhChi: $("#qdTiepTucSauTamDinhChi").val(),
            qdDinhChi: $("#qdDinhChi").val(),
            daThiHanhXong: $("#daThiHanhXong").val(),
            ghiChu: $("#ghiChu").val(),
            veThoiHanGuiQD: $("#veThoiHanGuiQD").val(),
            veCanCuBanHanhQD: $("#veCanCuBanHanhQD").val(),
            veThamQuyenBanHanhQD: $("#veThamQuyenBanHanhQD").val(),
            veHinhThucQD: $("#veHinhThucQD").val(),
            veNoiDungQD: $("#veNoiDungQD").val(),
            noiDungKhac: $("#noiDungKhac").val(),
            maPhieu: $("#maPhieu").val(),
            vienKsndCap: $("#vienKsndCap").val(),
            khuVuc: $("#khuVuc").val(),
            quanDiemKSV: $("#quanDiemKSV").val()
        };

        $.ajax({
            url: "/api/so-thu-ly",
            method: data.id ? "PUT" : "POST",
            contentType: "application/json",
            data: JSON.stringify(data),
            success: function () {
                searchData(0); // reload bằng AJAX, không reload page
                hideLoader();
                $("#editModal").modal("hide");
            }
        });
    }


    /* ====== XÓA ====== */
    function deleteItem(id) {
        if (!confirm("Bạn có chắc muốn xóa?")) return;
        showLoader();
        $.ajax({
            url: "/api/so-thu-ly/" + id,
            method: "DELETE",
            success: function () {
                searchData(0);
                hideLoader();
            }
        });
    }


    /* ====== EXPORT ====== */
    function exportExcel() {
        showLoader();
        window.location.href = "/api/so-thu-ly/export";
        setTimeout(hideLoader, 2000);
    }


    /* ====== DOWNLOAD DOC ====== */
    function showloadFileDoc(id) {
        if (!confirm("Bạn có muốn download file DOC?")) return;
        showLoader();
        window.location.href = "/api/so-thu-ly/download-doc/" + id;
        setTimeout(hideLoader, 2000);
    }


    /* ====== SEARCH AJAX + PAGINATION ====== */
    function searchData(page = 0) {
        showLoader();
        $.ajax({
            url: "/api/so-thu-ly/search",
            method: "GET",
            data: {
                from: $("#searchFrom").val(),
                to: $("#searchTo").val(),
                page: page,
                size: 10
            },
            success: function (res) {
                renderTable(res.content);
                renderPagination(res);
                hideLoader();
            }
        });
    }


    function renderTable(list) {
        let html = "";
        let index = 1;

        list.forEach(item => {
            html += `
                <tr>
                    <td>
                        <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                        <span>${index++}</span>
                    </td>
                    <td>
                        <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                        <span>${item.formatDateNgayTl || ""}</span>
                    </td>

                    <td>
                        <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                        <span>${item.banAnQuyetDinh || ""}</span>
                    </td>

                    <td>
                        <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                        <span>${item.personWhoMustExecute || ""}</span>
                    </td>

                    <td>
                        <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                        <span>${item.personToBeExecuted || ""}</span>
                    </td>

                    <td>
                        <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                        <span>${item.qdUyThacDi || ""}</span>
                    </td>

                    <td>
                        <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                        <span>${item.qdUyThacDen || ""}</span>
                    </td>

                    <td>
                        <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                        <span>${item.qdTha || ""}</span>
                    </td>

                    <td>
                        <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                        <span>${item.ndThiHanh || ""}</span>
                    </td>

                    <td>
                        <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                        <span>${item.qdChuaCoDieuKien || ""}</span>
                    </td>

                    <td>
                        <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                        <span>${item.qdRutTha || ""}</span>
                    </td>

                    <td>
                        <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                        <span>${item.qdHoanTha || ""}</span>
                    </td>

                    <td>
                        <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                        <span>${item.qdTiepTucSauHoan || ""}</span>
                    </td>

                    <td>
                        <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                        <span>${item.qdTamDinhChi || ""}</span>
                    </td>

                    <td>
                        <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                        <span>${item.qdTiepTucSauTamDinhChi || ""}</span>
                    </td>

                    <td>
                        <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                        <span>${item.qdDinhChi || ""}</span>
                    </td>

                    <td>
                        <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                        <span>${item.daThiHanhXong || ""}</span>
                    </td>

                    <td>
                        <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                        <span>${item.ghiChu || ""}</span>
                    </td>

                    <td>
                        <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                        <span>${item.veThoiHanGuiQD || ""}</span>
                    </td>

                    <td>
                        <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                        <span>${item.veCanCuBanHanhQD || ""}</span>
                    </td>

                    <td>
                        <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                        <span>${item.veThamQuyenBanHanhQD || ""}</span>
                    </td>

                    <td>
                        <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                        <span>${item.veHinhThucQD || ""}</span>
                    </td>

                    <td>
                        <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                        <span>${item.veNoiDungQD || ""}</span>
                    </td>

                    <td>
                        <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                        <span>${item.noiDungKhac || ""}</span>
                    </td>

                    <td>
                        <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                        <span>${item.quanDiemKSV || ""}</span>
                    </td>

                    <td>
                        <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                        <span>${item.khuVuc || ""}</span>
                    </td>

                    <td>
                        <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                        <span>${item.vienKsndCap || ""}</span>
                    </td>

                    <td>
                        <button class="btn-copy" onclick="copyTdValue(this)"><i class="fa fa-copy"></i></button>
                        <span>${item.maPhieu || ""}</span>
                    </td>
                    <td class="sticky-action">
                        <button class="btn btn-warning btn-sm" onclick="openEditModal(${item.id})">Sửa</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteItem(${item.id})">Xóa</button>
                        <button class="btn btn-info btn-sm" onclick="showloadFileDoc(${item.id})"><i class="fa fa-download"></i> .Doc</button>
                    </td>
                </tr>
            `;
        });

        $("#tableBody").html(html);
    }

    function copyCell(td) {
        const value = td.innerText.trim();
        if (!value) return;

        navigator.clipboard.writeText(value).then(() => {
            td.style.background = "#ffff99";
            setTimeout(() => td.style.background = "", 300);
        });
    }

    function copyTdValue(btn) {
        const td = btn.parentElement;
        const value = td.querySelector("span").innerText.trim();

        navigator.clipboard.writeText(value).then(() => {

            // Tạo tooltip
            let tooltip = document.createElement("div");
            tooltip.className = "copy-tooltip";
            tooltip.innerText = "Đã copy!";

            // Thêm vào body để nó tách khỏi td
            document.body.appendChild(tooltip);

            // Lấy vị trí button để đặt tooltip đúng chỗ
            const rect = btn.getBoundingClientRect();

            tooltip.style.left = rect.left + window.scrollX + "px";
            tooltip.style.top = rect.top + window.scrollY - 30 + "px"; // nằm trên nút 30px

            // hiệu ứng fade
            setTimeout(() => {
                tooltip.classList.add("fade-out");
            }, 700);

            // xoá tooltip
            setTimeout(() => {
                tooltip.remove();
            }, 1000);
        });
    }


    function renderPagination(res) {
        let current = res.number;
        let total = res.totalPages;

        let html = "";

        for (let i = 0; i < total; i++) {
            html += `
                <button class="btn btn-sm ${i === current ? "btn-primary" : "btn-outline-primary"}"
                        onclick="searchData(${i})">
                    ${i + 1}
                </button>
            `;
        }

        $("#pagination").html(html);
    }


    /* ====== LOAD LẦN ĐẦU ====== */
    $(document).ready(function () {
        searchData(0);
    });

</script>

</body>
</html>
